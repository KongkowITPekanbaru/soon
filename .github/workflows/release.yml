---
name: "â­• Release"
on:
  # manual trigger
  workflow_dispatch:

jobs:
  bump_version:
    name: "ğŸ“¦ Bump Version"
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.github_tag_action.outputs.new_tag }}
      changelog: ${{ steps.github_tag_action.outputs.changelog }}
    steps:
      - name: "ğŸ§‘â€ğŸ’» Checkout"
        uses: actions/checkout@v3

      - name: "ğŸ“¦ Bump version and push tag"
        id: github_tag_action
        uses: mathieudutour/github-tag-action@v5.6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: .*

  create_release:
    name: "ğŸš€ Create Release"
    runs-on: ubuntu-latest
    needs: bump_version
    if: ${{ needs.bump_version.outputs.new_tag != null }}
    steps:
      - name: "ğŸ§‘â€ğŸ’» Checkout"
        uses: actions/checkout@v3

      - name: "ğŸ’» Set up node"
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: "ğŸ“¦ Install dependencies"
        run: yarn install --immutable --immutable-cache

      - name: "ğŸ‘· Build the app"
        run: yarn run build

      - name: "ğŸ‘· Export SSG"
        run: yarn run export

      - name: "ğŸš€ Deploy to Swarm"
        uses: aquiladev/swarm-action@v0.1.1
        id: swarm
        with:
          path: ./out
          verbose: true

      - name: "ğŸš€ Deploy to Web3"
        uses: 10xHuman/add-to-web3@main
        id: web3
        with:
          path_to_add: "out"
          file_name: "Kongkow ${{ needs.bump_version.outputs.new_tag }}"
          web3_token: ${{ secrets.WEB3_STORAGE_TOKEN}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ“¦ Collect CID's"
        uses: mathiasvr/command-output@v1.1.0
        id: cidv0
        run: yarn cid ${{ steps.web3.outputs.cid }}

      - name: "âš¡ Update DNS with new IPFS hash"
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
          RECORD_DOMAIN: "kongkowitpku.xyz"
          RECORD_NAME: "_dnslink"
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: npx dnslink-cloudflare --record _dnslink --domain kongkowitpku.xyz --link /ipfs/${{ steps.web3.outputs.cid }}

      - name: "âš¡ Update Unstoppable Domains"
        uses: aquiladev/ddns-action@v0.3.0
        with:
          mnemonic: ${{ secrets.MNEMONIC }}
          rpc: ${{ secrets.RPC }}
          name: kongkowitpku.blockchain
          contentHash: ${{ steps.web3.outputs.cid }}

      - name: "ğŸ†™ Create GitHub Release"
        id: create_release
        uses: actions/create-release@v1.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.bump_version.outputs.new_tag }}
          release_name: Release ${{ needs.bump_version.outputs.new_tag }}
          body: |
            ### Alternative deployment:
            - **CIDv0**: `${{ steps.cidv0.outputs.stdout }}`
            - **CIDv1**: `${{ steps.web3.outputs.cid }}`
            The latest release is always accessible via an alias to the Cloudflare IPFS gateway at [kongkowitpku.xyz](https://kongkowitpku.xyz).
            You can also access This Page from any IPFS gateway.
            - [`${{ steps.web3.outputs.cid }}`.ipfs.w3s.link](https://${{ steps.web3.outputs.cid }}.ipfs.w3s.link)
            - [`${{ steps.web3.outputs.cid }}`.ipfs.dweb.link](https://${{ steps.web3.outputs.cid }}.ipfs.dweb.link)
            - [`${{ steps.web3.outputs.cid }}`.ipfs.cf-ipfs.com](https://${{ steps.web3.outputs.cid }}.ipfs.cf-ipfs.com)
            - **Unstoppable Domains**: [`kongkowitpku.blockchain`](https://kongkowitpku.blockchain)
